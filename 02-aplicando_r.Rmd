# R en Acci√≥n: Analizando un Ejemplo

R es una herramienta de an√°lisis muy poderosa. El prop√≥sito de este cap√≠tulo es principalmente mostrar algunas de las cosas que puede hacer R, especialmente c√≥mo cargar un base de datos desde una pagina web, describir algunas funciones b√°sicas, c√≥mo limpiar una base de datos (esto es particularmente cr√≠tico ya que se estima que el 80% del tiempo dedicado al an√°lisis de datos es para limpiar y producir una base de datos que sea analizable) y c√≥mo graficar. Si bien explico los objetivos del an√°lisis de datos para cada parte junto con el c√≥digo utilizado, la idea principal es ilustrar algunas de sus funcionalidades y no explicar el c√≥digo de forma extensa. Para eso, est√° el resto de las secciones del libro. 

## Cargando una Base de Datos desde la Web

Primero que todo, un breve resumen de la base de datos que utilizaremos en este cap√≠tulo. La base contiene datos sociodemogr√°ficos, calificaciones de cinco cursos y respuestas a preguntas sobre emociones en el contexto acad√©mico de 137 estudiantes de psicolog√≠a de una universidad p√∫blica chilena. De este modo, lo que vamos a hacer es cargar la base de datos para ejecutar nuestros ejemplos. Para esto, vamos a darle un nombre o etiqueta a nuestra base de datos `dataset`, luego utilizaremos el *operador de asignaci√≥n* `<-` y al lado derecho usaremos la funci√≥n `read.csv()` de R, el cual permite leer la base de datos llamada `emociones_academicas.csv`. Si deseas ejecutar el c√≥digo contenido en este ejemplo, primero debes tener instalado en tu computador el lenguaje de programaci√≥n R y RStudio (Para m√°s informaci√≥n ir al cap√≠tulo 3, donde est√°n las instrucciones paso a paso de c√≥mo hacer esto). Volviendo al archivo csv, n√≥tese que la base de datos est√° alojada en una p√°gina web y no en nuestro computador personal. Esto ya en s√≠ mismo muestra una de las ventajas de R por sobre otros *software* de an√°lisis de datos tales como SPSS. Inmediatamente abajo del c√≥digo para cargar la base de datos, utilizaremos la funci√≥n `names` para observar el nombre de las variables contenidas en la base de datos, el cual se encuentra impreso justo debajo de la celda.    
 
```{r}
dataset <- read.csv("https://raw.githubusercontent.com/danielivanperez/dataset_ejemplo_libro_r/main/emociones_academicas.csv")

names(dataset)
```

Para saber el tama√±o de nuestra base de datos, podemos utilizar la funci√≥n `dim()`, la cual nos entrega el n√∫mero de filas y columnas respectivamente. Apliquemos dicha funci√≥n a la base de datos reci√©n cargada. 

```{r}
dim(dataset)
```
La salida nos dice que hay 137 filas (participantes en nuestro caso) y 22 columnas (o variables). Adicionalmente, una de las funciones m√°s √∫tiles de R es poder observar un conjunto acotado de filas, observaciones o, en nuestro caso participantes, de la base de datos a analizar. Para esto, vamos a usar la funci√≥n `head()`. Al ejecutar esta funci√≥n, R nos muestra las primeras 6 filas de la base de datos. 

```{r}
head(dataset)
```

## Seleccionando Columnas en una Base de Datos

El c√≥digo de arriba nos muestra las respuestas de los primeros 6 sujetos de nuestra base de datos. Podemos f√°cilmente ver que la salida o *output* que nos da R es relativamente extensa. Ser√≠a muy ineficiente siempre estar imprimiendo bases de datos de forma completa. Por esta raz√≥n, es mucho mejor trabajar viendo un n√∫mero limitado de variables al mismo tiempo. Empecemos con el caso m√°s simple de explorar solo una variable. A continuaci√≥n, vamos a mostrar c√≥mo utilizar el s√≠mbolo d√≥lar `$`, el cual nos permite seleccionar una columna o variable de la base de datos. Para proseguir con el ejemplo, nos centraremos en la variable `calificacion_1`. De este modo, primero escribimos el nombre de la base de datos, seguido del signo d√≥lar y, luego, seleccionar o escribir el nombre de la variables deseada (n√≥tese que seguimos utilizando la funci√≥n `head()` con el objetivo de tener solo 6 filas en la salida de R). 

```{r}
head(dataset$calificacion_1)
```

La salida de R nos muestra las primeras 6 filas de la `variable calificacion_1`. Para mencionar otra forma √∫til de selecci√≥n de columnas que usaremos m√°s abajo, est√° elegir un rango de columnas como por ejemplo: 

```{r}
head(dataset[5:9]) 
```
Podemos inferir del c√≥digo escrito arriba que R le asigna un n√∫mero a cada una de las columnas de la base de datos empezando desde 1.  Al interior del par√©ntesis cuadrado, le pedimos a R que seleccione desde la columna 5 hasta la columna 9 y que nos muestre s√≥lo estas columnas o variables. De este modo, R muestra los valores desde la variable `calificacion_1` hasta `calificacion_5`.

## Limpiando Valores en una Base de Datos

Volviendo al caso, como podemos ver en las primeras 6 filas de la variable ` calificacion_1`, a los participantes se les pidi√≥ escribir sus calificaciones para un curso determinado. Podemos observar que ellos escribieron sus respuestas de diferentes formas. Por ejemplo, escribiendo solo la calificaci√≥n como en el primer caso, o incluso escribiendo el nombre del curso de manera completa y luego la calificaci√≥n, en otros casos con un `.` como en la fila [1], con una `,` como en la fila [3] o simplemente sin punto ni coma como en la fila [6]. Esto constituir√≠a un primer problema para el analista de datos debido a que no tenemos los valores ordenados y formateados de manera est√°ndar (por ejemplo, tener solo n√∫meros dos n√∫meros separados por un `.`) al interior de la variable. Justamente en este tipo de situaciones es cuando R muestra todo su poder y utilidad. 

Como en cada respuesta o celda de la columna tenemos una combinaci√≥n de texto y n√∫meros, voy a aplicar una funci√≥n en R para que transforme todo lo que haya en sus celdas a un tipo de formato llamado `character` o car√°cter, el cual se refiere a que la informaci√≥n dentro de cada celda es simplemente texto (en R hay diferentes tipos de datos como los num√©ricos o `numeric`). Esto lo hago principalmente para proceder de manera ordenada y evitar posibles errores en el futuro al ejecutar c√≥digo.  

```{r}
dataset[5:9] <- lapply(dataset[5:9], as.character) # transformar los datos a caracteres
```

De forma muy resumida, el c√≥digo de arriba lo que hizo fue aplicar una funci√≥n que transforma el tipo de datos de cada celda a caracteres a un set de columnas definida desde `[5:9]` (es decir, desde `calificacion_1` a ` calificacion_5`) de la base de datos `dataset`. N√≥tese que en la segunda parte del c√≥digo hay un signo hashtag `#`, el cual le dice a R que todo lo que est√° despu√©s de dicho s√≠mbolo no debe ser ejecutado. El `#` lo usamos cuando queremos escribir comentarios junto al c√≥digo para describir qu√© fue lo que hicimos como una ayuda de memoria (luego de un par de d√≠as, semanas o meses, esto ser√° de mucha ayuda) o para explicarle a alguien cada paso del c√≥digo.  

Ahora bien, lo que haremos a continuaci√≥n es eliminar todo lo que no sea n√∫meros (letras, puntuaciones, etc.) para las variables `calificacion_1` a ` calificacion_5` y, obviamente, dejar solo n√∫meros o calificaciones en las celdas. Para esto, utilizaremos el c√≥digo que est√° abajo, el cual es aplicado a cada una de las calificaciones existentes en la base de datos con el fin de hacer m√°s comprensible el ejemplo.

```{r}
dataset$calificacion_1 <- gsub("[^0-9]", "", dataset$calificacion_1)
dataset$calificacion_2 <- gsub("[^0-9]", "", dataset$calificacion_2)
dataset$calificacion_3 <- gsub("[^0-9]", "", dataset$calificacion_3)
dataset$calificacion_4 <- gsub("[^0-9]", "", dataset$calificacion_4)
dataset$calificacion_5 <- gsub("[^0-9]", "", dataset$calificacion_5)
```

Si ejecutamos los nuevos valores contenidos en las columnas 5 a 9, observaremos que solo hay n√∫meros en las celdas. 

```{r}
head(dataset[5:9])
```
En esta etapa, los valores ya empiezan a estar mucho m√°s ordenados y cada vez est√°n m√°s cerca del formato final que deseamos para ejecutar algunos an√°lisis de datos de utilidad. Sin embargo, todav√≠a tenemos, al menos, dos problemas. El primero es que las calificaciones deber√≠an tener un punto `.` entremedio de ambos n√∫meros y, en segundo lugar, que no debemos olvidar que el contenido de las celdas est√° almacenado como caracteres y no como n√∫meros. Es muy importante que nuestras variables sean le√≠das por R como variables num√©ricas para proceder con la aplicaci√≥n de funciones cuantitativas. Por ejemplo, si las variables est√°n formateadas como caracteres y queremos aplicar la funci√≥n de media aritm√©tica, R imprimir√° un mensaje de error. 

De este modo, lo primero que haremos es resolver el problema del punto entre ambos n√∫meros. Para esto, usaremos el c√≥digo que esta abajo. N√≥tese que cada funci√≥n se ha aplicado a cada una de las cinco variables por separado con el fin de que el ejemplo sea m√°s entendible. 

```{r}
dataset$calificacion_1 <- sub("(?<=^.)", "\\.", dataset$calificacion_1 , perl=TRUE)
dataset$calificacion_2 <- sub("(?<=^.)", "\\.", dataset$calificacion_2 , perl=TRUE)
dataset$calificacion_3 <- sub("(?<=^.)", "\\.", dataset$calificacion_3 , perl=TRUE)
dataset$calificacion_4 <- sub("(?<=^.)", "\\.", dataset$calificacion_4 , perl=TRUE)
dataset$calificacion_5 <- sub("(?<=^.)", "\\.", dataset$calificacion_5 , perl=TRUE)
```

```{r}
head(dataset[5:9])
```
Genial, ahora cada una de las calificaciones tiene un punto que separa ambos valores. Solo con algunas l√≠neas de c√≥digo nos hemos ahorrado, por ejemplo, hacer este procedimiento de forma manual. Es decir, escribiendo un punto para cada valor en las celdas de las variables multiplicado por 137 participantes. Probablemente esto nos hubiera dejado de muy mal humor y habiendo gastado mucho tiempo y con posibles errores en nuestra base de datos ü•≤.

Pero a√∫n queda un problema m√°s por resolver: cambiar el contenido de la celda de car√°cter a n√∫mero. Para ilustrar de forma m√°s clara el problema, imaginemos que queremos saber la media aritm√©tica de la variable `calificacion_1`:


```{r}
mean(dataset$calificacion_1, na.rm = TRUE) # na.rm = True descarta las celdas sin valores 
```
El mensaje de error dice lo siguiente: ‚Äúargument is not numeric or logical: returning NA[1] NA‚Äù. B√°sicamente lo que est√° sucediendo aqu√≠ es que R no puede aplicar una operaci√≥n matem√°tica a texto o caracteres. Para solucionar esto, solo debemos ejecutar el siguiente c√≥digo que transformar√° el texto a n√∫meros. 


```{r}
dataset[5:9] <- lapply(dataset[5:9], as.numeric) # Convertir columnas de 5 a 9 a numeros
```

Ahora apliquemos nuevamente la funci√≥n de media aritm√©tica a la variable `calificacion_1` y veamos qu√© sucede:

```{r}
mean(dataset$calificacion_1, na.rm = TRUE)
``` 
Al fin hemos obtenido el valor promedio para esa columna el cual corresponde a 4.38176. Esto quiere decir que los valores de las columnas est√°n listos para ser analizados cuantitativamente. Antes de pasar a la siguiente secci√≥n, me gustar√≠a presentar la funci√≥n  `sum()` o *summary*, la cual es una de las funciones m√°s frecuentes de R y, b√°sicamente, nos entrega un resumen general de las variables descriptivas de una variable cuantitativa. Para ilustrarla, apliquemos dicha funci√≥n a la columna `calificacion_1`:

```{r}
summary(dataset$calificacion_1)
```

La salida de R muestra siete valores: el puntaje m√≠nimo, el puntaje del primer cuartil, la mediana, la media aritm√©tica, el puntaje del tercer cuartil y el n√∫mero de celdas con valores perdidos o NA‚Äôs (o *Not Available*).


## Creaci√≥n de Variables a partir de Otras

```{r}
dataset$promedio <- rowMeans(dataset[,5:9], na.rm=TRUE)
```

```{r}
dataset$emociones_positivas <- rowMeans(dataset[,c("emo_aca_1","emo_aca_3","emo_aca_5","emo_aca_7", "emo_aca_9","emo_aca_11")], na.rm=TRUE)

dataset$emociones_negativas <- rowMeans(dataset[,c("emo_aca_2","emo_aca_4","emo_aca_6","emo_aca_8", "emo_aca_10","emo_aca_12")], na.rm=TRUE)
```

## Graficando Datos 

```{r}
barplot(table(dataset$emociones_positivas)) #both columns need to be integer
```


```{r}
plot(dataset$emociones_positivas, dataset$promedio) #both columns need to be integer
```

```{r}
require(stats)

reg<-lm(dataset$promedio ~ dataset$emociones_positivas, data = dataset)

plot(dataset$emociones_positivas, dataset$promedio)

abline(reg, col = "green")

reg
```

```{r}
require(stats)

reg_1<-lm(dataset$promedio ~ dataset$emociones_negativas, data = dataset)

plot(dataset$emociones_negativas, dataset$promedio)

abline(reg_1, col = "red")

reg_1
```
 


